%%
%% This is file `sample-acmsmall.tex',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% samples.dtx  (with options: `acmsmall')
%% 
%% IMPORTANT NOTICE:
%% 
%% For the copyright see the source file.
%% 
%% Any modified versions of this file must be renamed
%% with new filenames distinct from sample-acmsmall.tex.
%% 
%% For distribution of the original source see the terms
%% for copying and modification in the file samples.dtx.
%% 
%% This generated file may be distributed as long as the
%% original source files, as listed above, are part of the
%% same distribution. (The sources need not necessarily be
%% in the same archive or directory.)
%%
%% Commands for TeXCount
%TC:macro \cite [option:text,text]
%TC:macro \citep [option:text,text]
%TC:macro \citet [option:text,text]
%TC:envir table 0 1
%TC:envir table* 0 1
%TC:envir tabular [ignore] word
%TC:envir displaymath 0 word
%TC:envir math 0 word
%TC:envir comment 0 0
%%
%%
%% The first command in your LaTeX source must be the \documentclass command.
\documentclass[acmsmall,review, nonacm]{acmart}
%% NOTE that a single column version is required for 
%% submission and peer review. This can be done by changing
%% the \doucmentclass[...]{acmart} in this template to 
%% \documentclass[manuscript,screen]{acmart}
%% 
%% To ensure 100% compatibility, please check the white list of
%% approved LaTeX packages to be used with the Master Article Template at
%% https://www.acm.org/publications/taps/whitelist-of-latex-packages 
%% before creating your document. The white list page provides 
%% information on how to submit additional LaTeX packages for 
%% review and adoption.
%% Fonts used in the template cannot be substituted; margin 
%% adjustments are not allowed.
%%
%% \BibTeX command to typeset BibTeX logo in the docs
\AtBeginDocument{%
  \providecommand\BibTeX{{%
    \normalfont B\kern-0.5em{\scshape i\kern-0.25em b}\kern-0.8em\TeX}}}

%% Rights management information.  This information is sent to you
%% when you complete the rights form.  These commands have SAMPLE
%% values in them; it is your responsibility as an author to replace
%% the commands and values with those provided to you when you
%% complete the rights form.
% \setcopyright{acmlicensed}
% \copyrightyear{2024}
% \acmYear{2024}
% \acmDOI{XXXXXXX.XXXXXXX}

%%
%% The majority of ACM publications use numbered citations and
%% references.  The command \citestyle{authoryear} switches to the
%% "author year" style.
%%
%% If you are preparing content for an event
%% sponsored by ACM SIGGRAPH, you must use the "author year" style of
%% citations and references.
%% Uncommenting
%% the next command will enable that style.
%%\citestyle{acmauthoryear}

%% Code listing commands
\usepackage{listings}
\usepackage{xcolor}

% Theme is everforest light from: https://gogh-co.github.io/Gogh/
\definecolor{codegreen}{RGB}{167, 192, 128}
\definecolor{codeblack}{RGB}{75, 86, 91}
\definecolor{codegray}{RGB}{92, 106, 114}
%\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{RGB}{253, 246, 227}
\definecolor{codeblue}{RGB}{57, 148, 197}


\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{codeblue},
    numberstyle=\tiny\color{codegray},
    %stringstyle=\color{codepurple},
    basicstyle=\ttfamily\scriptsize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2,
    xleftmargin=0.3cm,
    frame=tlbr,  
    framerule=0pt,
}

\lstset{style=mystyle}
%%
%% end of the preamble, start of the body of the document source.
\begin{document}

%%
%% The "title" command has an optional parameter,
%% allowing the author to define a "short title" to be used in page headers.
\title{Binary Analysis for Missed Vectorization Opportunities Detection}

%%
%% The "author" command and its associated commands are used to define
%% the authors and their affiliations.
%% Of note is the shared affiliation of the first two authors, and the
%% "authornote" and "authornotemark" commands
%% used to denote shared contribution to the research.
\author{Amos Herz}
\email{amherz@ethz.ch}
\author{Alessandro Legnani}
\email{alegnani@ethz.ch}

\affiliation{%
  \institution{ETH Zürich}
  \city{Zürich}
  \country{Switzerland}
  \postcode{8092}
}

%%
%% By default, the full list of authors will be used in the page
%% headers. Often, this list is too long, and will overlap
%% other information printed in the page headers. This command allows
%% the author to define a more concise list
%% of authors' names for this purpose.
\renewcommand{\shortauthors}{Herz and Legnani}

%%
%% The abstract is a short summary of the work to be presented in the
%% article.
\begin{abstract}
  
\end{abstract}

%%
%% The code below is generated by the tool at http://dl.acm.org/ccs.cfm.
%% Please copy and paste the code instead of the example below.
%%
% TODO: ?
% \begin{CCSXML}
% <ccs2012>
%  <concept>
%   <concept_id>00000000.0000000.0000000</concept_id>
%   <concept_desc>Do Not Use This Code, Generate the Correct Terms for Your Paper</concept_desc>
%   <concept_significance>500</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>00000000.00000000.00000000</concept_id>
%   <concept_desc>Do Not Use This Code, Generate the Correct Terms for Your Paper</concept_desc>
%   <concept_significance>300</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>00000000.00000000.00000000</concept_id>
%   <concept_desc>Do Not Use This Code, Generate the Correct Terms for Your Paper</concept_desc>
%   <concept_significance>100</concept_significance>
%  </concept>
%  <concept>
%   <concept_id>00000000.00000000.00000000</concept_id>
%   <concept_desc>Do Not Use This Code, Generate the Correct Terms for Your Paper</concept_desc>
%   <concept_significance>100</concept_significance>
%  </concept>
% </ccs2012>
% \end{CCSXML}

% \ccsdesc[500]{Do Not Use This Code~Generate the Correct Terms for Your Paper}
% \ccsdesc[300]{Do Not Use This Code~Generate the Correct Terms for Your Paper}
% \ccsdesc{Do Not Use This Code~Generate the Correct Terms for Your Paper}
% \ccsdesc[100]{Do Not Use This Code~Generate the Correct Terms for Your Paper}

%%
%% Keywords. The author(s) should pick words that accurately describe
%% the work being presented. Separate the keywords with commas.
% \keywords{Do, Not, Us, This, Code, Put, the, Correct, Terms, for,
%   Your, Paper}

% \received{20 February 2007}
% \received[revised]{12 March 2009}
% \received[accepted]{5 June 2009}

%%
%% This command processes the author and affiliation and title
%% information and builds the first part of the formatted document.
\maketitle

\section{Introduction}
Modern compilers are often able to automatically vectorize code using 
SIMD instructions.
Take, as an example, the following code snippet: 

\lstinputlisting[caption={\texttt{copy.c}}, label={lst:copy}, language=C]{listings/copy.c}

\noindent We can compile it with the following set of compiler flags
\begin{itemize}
  \item \texttt{-O3}: tells the compiler to use the highest level
        of optimization available.
  \item \texttt{-fno-tree-loop-distribute-patterns}:
        prevents replacing the loop with a call to \texttt{memcpy}
  \item \texttt{-fno-tree-vectorize}: prevents vectorization
\end{itemize}

\noindent Which will produce the following assembly code:

\lstinputlisting[caption={\texttt{copy.c} compiled with vectorizations disabled}, label={lst:copy_compiled}]{listings/copy.s}

\noindent However, by compiling without the \texttt{-fno-tree-vectorize} flag,
the compiler will produce the following vectorized code (note the use of wider instructions and registers):

\lstinputlisting[caption={\texttt{copy.c} compiled with vectorizations enabled}, label={lst:copy_vectorized}]{listings/copy_vectorized.s}

\noindent The main goal of this project is to develop a method for identifying missed opportunities 
for vectorization in existing code. That is, given an existing binary, we want to identify 
loops that could be vectorized but are not.

\section{Related Work}
Autovectorization is \textit{difficult}, compilers tend to miss many optimizations (as shown by \citet{Feng2021})
, and more than often
vectorizing a small piece of code requires large changes to the whole code base 
(as was done for example by \citet{Chen22}).

Compilers have been shown to widely miss out on vectorization opportunities. As an example, \citet{Maleki2021} report that
in their research only 45-71\% of the loops in a benchmark they developed and only a few loops from the real applications 
are vectorized by the compilers they evaluated, which include widely popular compilers such as \texttt{GCC} (version 4.7.0).

Auto-vectorization is still an open field of research: attempts have been made at ``fixing'' the compiler work
by post-processing compiled code (\citet{Porpodas2021}) or by applying Machine Learning to produce improved vectorization schemes
(\citet{Mendis2019}).

\section{Approach}
\subsection{Dataflow Analysis}
Let's look at Listing~\ref{lst:copy_compiled}: there, we can realize that 
the \texttt{load} and \texttt{store} instructions are completely independent (from other instructions of the same type) 
and could, theoretically, be computed in parallel, therefore vectorized. This can be concluded by simply looking at the dataflow,
an example on how a dataflow graph could look like is given in Figure~\ref{fig:dataflow}.

\begin{figure}[h!]
  \includegraphics*[width=0.4\linewidth]{img/dataflow.png}
  \caption{Example of dataflow graph for \texttt{copy.c}}
  \label{fig:dataflow}
\end{figure}

\subsection{Dynamic Analysis}
In order to build a dataflow graph we will be using the dynamic analysis framework 
\texttt{Intel Pin}\footnote{\url{https://software.intel.com/sites/landingpage/pintool/docs/98830/Pin/doc/html/index.html}}.
Intel Pin allows us to instrument single instructions in the assembly to generate 
the appropriate trace information to construct our dataflow graph. 
We opted to use dynamic analysis in our approach as it simplifies the approach of finding missed vectorization when 
compared to an approach using static analysis. 
When using dynamic analysis one needs to be careful not to falsely report code with 
complex control flow as non-optimized only considering the memory accesses 
observed by dynamic analysis.
\lstinputlisting[caption={Example of XXX}, label={lst:dyn}]{listings/dyn.c}
Assuming that in an execution of function \texttt{dyn} from Listing \ref{lst:dyn} 
we have that every element of array \texttt{c} is 0. In this case we would 
observe that \texttt{a = 4 * b} and vectorization is trivial using the \texttt{addps} instruction.
Therefore, we would flag this code as missing vectorization without considering 
the control flow operation (this example is trivially vectorizable using masked 
vector operations but one can consider complex control flow that can't be vectorized). 
To fix this issue we can either use static analysis or consider the control 
flow operation in our dataflow graph.
We plan on using the second approach as it is less complex to implement and are 
aware of the loss in precision this results in.

%%Given the trace of execution of a program (instructions and memory accesses), one can build a dataflow graph, on which a dataflow analysis 
%%can be performed to identify  ``parallel'' computations and thus, vectorization opportunities.

All in all, we foresee that building the dataflow graph will likely be the greatest challenge this project poses. An alternative,
would this challenge turn out to be too big of a one, could be to simply analyze the program trace directly, to track down for example repeating accesses
to increasing (or decreasing) memory addresses that would be vectorizable but are not.

\subsection{Examples of missed vectorization} \label{examples}
By searching on the different bug and issue trackers of the clang and gcc 
compiler we found two examples where the latest version of a compiler does not 
generate vectorized code. For this we are considering the latests versions of 
both gcc (13.2) and clang (18.1.0).
\subsubsection{Example 1}
The following examples has been taken from the gcc bug tracker\footnote{\url{https://gcc.gnu.org/bugzilla/show_bug.cgi?id=96888}}.
\lstinputlisting[caption={\texttt{example1.c}}, label={lst:ex1}]{listings/ex1.cpp}
One would expect the compiler to generate a mask from the \texttt{word} variable 
and perform masked multiplication to vectorize the code.
Compiling this code with the \texttt{-O3} flag on gcc yields no vectorized code 
as shown in Listing \ref{lst:ex1_gcc}, whereas clang unrolls the inner loop and, 
as expected, makes extensive use of vector instructions\footnote{\url{https://godbolt.org/z/W8v4Pc463}}.
\lstinputlisting[caption={\texttt{example1.c} compiled with \texttt{gcc -O3}}, label={lst:ex1_gcc}]{listings/ex1_gcc.S}



\subsection{Approach XXX: change name}
Our goal in the project is to be able to test for missed vectorization 
opportunities. 
As the possibility space of different kinds of missed vectorization 
opportunities is enourmous we will be focusing on some specific patterns.
Initially our approach will be to be able to recognize basic missed 
vectorizations, which don't appear in the wild anymore, like the one shown in 
\ref{lst:copy_compiled}.
Afterwards we will be focusing on pattern-matching the access patterns found in 
the two examples described in \ref{examples}, which is non-trivial work.
For this we will be using a combination of Pin's built in Dynamic Control-flow 
Graph Generation\footnote{\url{https://www.intel.com/content/www/us/en/developer/articles/technical/pintool-dcfg.html}} 
and our own PinTool to extract relevant traces.


\subsection{Test Inputs}
To test our results, we will use an already existing autovectorization benchmark such as \texttt{TSVC}\footnote{\url{https://github.com/UoB-HPC/TSVC\_2}}.
Other random program generators such \texttt{YARPGen}\footnote{\url{https://github.com/intel/yarpgen}} could be used to generate more, less specific, test inputs.

\section{Implementation and Experimental Settings}
To ease our work, and build a first prototype of our project, we focused on a specific version of a specific compiler, namely \texttt{gcc 13.2}.


%%
%% The acknowledgments section is defined using the "acks" environment
%% (and NOT an unnumbered section). This ensures the proper
%% identification of the section in the article metadata, and the
%% consistent spelling of the heading.
% \begin{acks}

% \end{acks}

%%
%% The next two lines define the bibliography style to be used, and
%% the bibliography file.
\bibliographystyle{ACM-Reference-Format}
\bibliography{report-references}

%%
%% If your work has an appendix, this is the place to put it.
% \appendix

% \section{Research Methods}

% \subsection{Part One}


% \subsection{Part Two}


% \section{Online Resources}


\end{document}
\endinput
%%
%% End of file `sample-acmsmall.tex'.
